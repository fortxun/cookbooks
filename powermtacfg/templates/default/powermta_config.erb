# Generated by Chef for <%= node[:fqdn] %>

postmaster postmaster@<%= node[:fqdn] %>
aliases-file /etc/pmta/aliases

smtp-listener <%= @ip_address %>:9587
total-max-smtp-in 800
total-max-smtp-out 6000

relay-domain m29.<%= @local_domain %>
host-name m29.<%= @local_domain %>
<virtual-mta m29>
  smtp-source-host <%= @ip_address %> m29.<%= @local_domain %>
</virtual-mta>

relay-domain m44.<%= @local_domain %>
host-name m44.<%= @local_domain %>
<virtual-mta m44>
  smtp-source-host <%= @ip_address %> m44.<%= @local_domain %>
</virtual-mta>

relay-domain m38.<%= @local_domain %>
host-name m38.<%= @local_domain %>
<virtual-mta m38>
  smtp-source-host <%= @ip_address %> m38.<%= @local_domain %>
</virtual-mta>

relay-domain m39.<%= @local_domain %>
host-name m39.<%= @local_domain %>
<virtual-mta m39>
  smtp-source-host <%= @ip_address %> m39.<%= @local_domain %>
</virtual-mta>

<source bounces>
  default-virtual-mta m30
</source>
smtp-listener <%= @ip_address %>:25 source=bounces

<source <%= @ip_address %>>
    always-allow-relaying yes   # allow feeding from <%= @ip_address %>
    process-x-virtual-mta yes   # allow selection of a virtual MTA
    max-message-size unlimited  # 0 implies no cap, in bytes
    smtp-service yes            # allow SMTP service
</source>

<source-group localSources>
    # max-smtp-in
    # reserved-smtp-in
</source-group>

<source <%= @ip_address %>/24>
    smtp-service yes
    always-allow-relaying yes
    source-group localSources
    default-virtual-mta m30 # if no X-virtual-MTA header is present, send mail from m30
    process-x-virtual-mta yes
    process-x-job yes
    #remove worker IPs from the received header so it doesn't confuse Gmail
    hide-message-source true
</source>

<source  <%= @ip_address %>>
    smtp-service yes
    always-allow-relaying yes
    source-group localSources
    default-virtual-mta m30 # if no X-virtual-MTA header is present, send mail from m30
    process-x-virtual-mta yes
    process-x-job yes
    #remove worker IPs from the received header so it doesn't confuse Gmail
    hide-message-source true
</source>

<source  <%= @ip_address %>>
    smtp-service yes
    always-allow-relaying yes
    source-group localSources
    default-virtual-mta m30 # if no X-virtual-MTA header is present, send mail from m30
    process-x-virtual-mta yes
    process-x-job yes
    #remove worker IPs from the received header so it doesn't confuse Gmail
    hide-message-source true
</source>

<source  <%= @ip_address %>>
    smtp-service yes
    always-allow-relaying yes
    source-group localSources
    default-virtual-mta m30 # if no X-virtual-MTA header is present, send mail from m30
    process-x-virtual-mta yes
    process-x-job yes
    #remove worker IPs from the received header so it doesn't confuse Gmail
    hide-message-source true
</source>

<source 0/0>                 # matches all
    log-connections no
    log-commands    no       # WARNING: verbose!
    log-data        no       # WARNING: even more verbose!
</source>


<%= render "domains.erb", :variables => {:important_domain => @important_domain } %>


domain-key test1,SOME_DOMAIN,/etc/pmta/test1.pem
domain-key test2,SOME_DOMAIN,/etc/pmta/test2.pem
domain-key test3,SOME_DOMAIN,/etc/pmta/test3.pem


<smtp-pattern-list backoff>
    reply /an error from a remote mail server goes here/ mode=backoff
    #
    #AOL Errors
    reply /421 .* SERVICE NOT AVAILABLE/ mode=backoff
    reply /generating high volumes of.* complaints from AOL/ mode=backoff
    reply /554 .*aol.com/ mode=backoff
    reply /421dynt1/ mode=backoff
    reply /HVU:B1/ mode=backoff
    reply /DNS:NR/ mode=backoff
    reply /RLY:NW/ mode=backoff
    reply /DYN:T1/ mode=backoff
    reply /RLY:BD/ mode=backoff
    reply /RLY:CH2/ mode=backoff
    #
    #Yahoo Errors
    reply /421 .* Please try again later/ mode=backoff
    reply /421 Message temporarily deferred/ mode=backoff
    reply /VS3-IP5 Excessive unknown recipients/ mode=backoff
    reply /VSS-IP Excessive unknown recipients/ mode=backoff
    #Hotmail Errors
    reply /exceeded the rate limit/ mode=backoff
    reply /exceeded the connection limit/ mode=backoff
    reply /Mail rejected by Windows Live Hotmail for policy reasons/ mode=backoff
    reply /mail.live.com\/mail\/troubleshooting.aspx/ mode=backoff
    #
    #Adelphia Errors
    reply /421 Message Rejected/ mode=backoff
    reply /Client host rejected/ mode=backoff
    reply /blocked using UCEProtect/ mode=backoff
</smtp-pattern-list>

domain-macro important_domain <%= @supported_domains %>

<domain *>
    smtp-pattern-list backoff
    backoff-to-normal-after 1h
    max-smtp-out    10       # max. connections *per domain*
    bounce-after    48h       # 30 hours
    retry-after     20m      # 20 minutes
    connect-timeout 2m       # so PowerMTA does not try to connect for too long when a domain is slow to respond
    dk-sign         no      # sign outgoing mail
    dkim-sign       yes      # sign outgoing mail
    second-dkim-sign        yes
    second-dkim-identity    @<%= node[:fqdn] %>
</domain>

http-mgmt-port 80

http-access <%= @ip_address %> admin

http-access <%= @ip_address %> monitor
http-access <%= @ip_address %> monitor


http-access <%= @ip_address %>/24 admin

sync-msg-create false

sync-msg-update false

run-as-root no


log-file /var/log/pmta/log        # logrotate is used for rotation

<acct-file /var/log/pmta/acct.csv>
    move-interval 5m
    max-size 50M
    record-fields delivery *,header_Message-Id
</acct-file>
spool /var/spool/pmta/current
spool /var/spool/pmta/current-2013-01-10
spool /var/spool/pmta/current-2013-01-15
spool /var/spool/pmta/from-pmta102-2013-06-12
spool /var/spool/pmta/from-pmta102-2013-06-13
spool /var/spool/pmta/from-pmta102-2013-06-14
spool-delete-corrupted true